(function(n,t){"use strict";typeof define=="function"&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],t):typeof exports=="object"?module.exports=t(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):n.PhotoClip=t(n.jQuery,n.IScroll,n.Hammer,n.lrz)})(this,function(n,t,i,r){"use strict";function s(t,i){var r=n.extend({},o,i);h.call(this,t,r)}function h(o,s){function ar(){vi=!0;et.append(this);ct(d,function(){a=this.naturalWidth;v=this.naturalHeight},this);ct(k,function(){yr()});cr.call(b,this)}function vr(){h=new t(ft[0],{zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"})}function yr(){p=0;w=0;c=0;rt=a;ut=v;et.css({width:a,height:v});si(et,p,w,c);ei(a,v);h.zoom(h.options.zoomStart);var n=(y-a*h.scale)*.5,t=(l-v*h.scale)*.5;h.scrollTo(n,t)}function ei(n,t){gr(n,t);h.scale<h.options.zoomMin&&h.zoom(h.options.zoomMin);k.css({width:n,height:t});ft.append(k);h.refresh()}function pr(){if(f){tt=new i.Manager(k[0]);tt.add(new i.Rotate);var n,t;tt.on("rotatemove",function(i){yt||(n=i.rotation,n>180?n-=360:n<-180&&(n+=360),t=n>0?1:n<0?-1:0)});tt.on("rotateend",function(i){yt||Math.abs(n)>30&&(t==1?oi(i.center):t==-1&&di(i.center))})}else k.on("dblclick",function(n){oi({x:n.clientX,y:n.clientY})})}function oi(n){gi(90,n)}function di(n){gi(-90,n)}function gi(n,t){var b;if(!yt){yt=!0;b=t?kr(k,t.x,t.y):tr(k,ft,y*.5,l*.5);var d=dr(c,b),i=d.x,r=d.y,o=0,s=0,f=0,e=0,u=c+n;u==90||u==-270?(o=i+r,s=r-i,u>c?(f=v-i-r,e=i-r):u<c&&(f=v-r-(a-i),e=i+r-v),rt=v,ut=a):u==180||u==-180?(o=i*2,s=r*2,u>c?(f=a-i-(v-r),e=v-(i+r)):u<c&&(f=a-(i+r),e=v-r-(a-i)),rt=a,ut=v):u==270||u==-90?(o=i-r,s=i+r,u>c?(f=i+r-a,e=a-i-(v-r)):u<c&&(f=r-i,e=a-i-r),rt=v,ut=a):(u==0||u==360||u==-360)&&(o=0,s=0,u>c?(f=i-r,e=i+r-a):u<c&&(f=i+r-v,e=r-i),rt=a,ut=v);c==0?(p=0,w=0):c==90||c==-270?(p-=i+r,w-=r-i):c==180||c==-180?(p-=i*2,w-=r*2):(c==270||c==-90)&&(p-=i-r,w-=i+r);p=p.toFixed(2)-0;w=w.toFixed(2)-0;si(et,p,w,c,i,r);tu(et,p,w,u,200,function(){yt=!1;c=u%360;p+=o+f;w+=s+e;p=p.toFixed(2)-0;w=w.toFixed(2)-0;si(et,p,w,c);h.scrollTo(h.x-f*h.scale,h.y-e*h.scale);ei(rt,ut)})}}function wr(){nt=document.createElement("canvas")}function br(){var i;if(!vi){console.log("当前没有图片可以裁剪!");ai.call(b,null);return}var r=tr(k,ft),t=h.scale,n=nt.getContext("2d");n.clearRect(0,0,nt.width,nt.height);n.save();ni&&ti?(nt.width=ni,nt.height=ti,n.scale(ni/y*t,ti/l*t)):(nt.width=y/t,nt.height=l/t);n.translate(p-r.x/t,w-r.y/t);n.rotate(c*Math.PI/180);n.drawImage(d[0],0,0);n.restore();try{i=nt.toDataURL(lt,or);ht.css("background-image","url("+i+")");ai.call(b,i)}catch(u){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。");}}function nr(){fr()}function tr(n,t,i,r){i=i||0;r=r||0;var u,f;return ct(n,function(){u=n.offset()}),ct(t,function(){f=t.offset()}),{x:f.left-u.left+i,y:f.top-u.top+r}}function kr(n,t,i){t=t||0;i=i||0;var r;return ct(n,function(){r=n.offset()}),{x:t+dt.scrollLeft()-r.left,y:i+dt.scrollTop()-r.top}}function ct(t,i,r){var u=n();n.each(t,function(t,i){for(var f=i instanceof jQuery?i:n(i),e=f.parents().addBack().filter(":hidden"),r,t=e.length;t--;){if(!f.is(":hidden"))break;r=e.eq(t);r.css("display")==="none"&&(u=u.add(r.show()))}});typeof i=="function"&&i.call(r||this);u.hide()}function dr(n,t){var r=h.scale,i={};return n==0?(i.x=t.x/r,i.y=t.y/r):n==90||n==-270?(i.x=t.y/r,i.y=v-t.x/r):n==180||n==-180?(i.x=a-t.x/r,i.y=v-t.y/r):(n==270||n==-90)&&(i.x=a-t.y/r,i.y=t.x/r),i}function ir(n,t,i,r){var u=n/i,f=t/r;return u>f?u:f}function gr(n,t){h.options.zoomMin=ir(y,l,n,t);h.options.zoomMax=Math.max(1,h.options.zoomMin);h.options.zoomStart=Math.min(h.options.zoomMax,ir(ri,ui,n,t))}function nu(){d&&d.length&&(d.off(),d.remove(),delete d[0])}function rr(t){nu();d=n("<img>").css({"user-select":"none","pointer-events":"none"});it||(it=!0,li.call(b,d[0]));d.on("load",ar);d.attr("src",t)}function si(n,t,i,r,f,e){f=f||0;e=e||0;var o={};o[u+"transform"]="translateZ(0) translate("+t+"px,"+i+"px) rotate("+r+"deg)";o[u+"transform-origin"]=f+"px "+e+"px";n.css(o)}function tu(n,t,i,r,f,o){n.css(u+"transform");n.css(u+"transition",u+"transform "+f+"ms");n.one(e,function(){n.css(u+"transition","");o.call(this)});n.css(u+"transform","translateZ(0) translate("+t+"px,"+i+"px) rotate("+r+"deg)")}function ur(n){var t=n+"";return/%$/.test(t)}function iu(){g=n(o).css({"user-select":"none",overflow:"hidden"});g.css("position")=="static"&&g.css("position","relative");ft=n('<div class="photo-clip-view">').css({position:"absolute",left:"50%",top:"50%"}).appendTo(g);k=n('<div class="photo-clip-moveLayer">').appendTo(ft);et=n('<div class="photo-clip-rotateLayer">').appendTo(k);var t=n('<div class="photo-clip-mask">').css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(g);yi=n('<div class="photo-clip-mask-left">').css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":"rgba(0,0,0,.5)"}).appendTo(t);pi=n('<div class="photo-clip-mask-right">').css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t);wi=n('<div class="photo-clip-mask-top">').css({position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t);bi=n('<div class="photo-clip-mask-bottom">').css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":"rgba(0,0,0,.5)"}).appendTo(t);ki=n('<div class="photo-clip-area">').css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%"}).appendTo(t);ht=n(sr);ht.length&&ht.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function fr(n,t){var u=bt,f=kt,i,r;typeof n=="number"&&(bt=n);typeof t=="number"&&(kt=t);y=bt;l=kt;(at||vt)&&(ii=bt/kt);ct(g,function(){ri=g.width();ui=g.height()});at&&(y=ri/100*parseFloat(at),vt||(l=y/ii));vt&&(l=ui/100*parseFloat(vt),at||(y=l*ii));ft.css({width:y,height:l,"margin-left":-y/2,"margin-top":-l/2});yi.css({"margin-right":y/2,"margin-top":-l/2,"margin-bottom":-l/2});pi.css({"margin-left":y/2,"margin-top":-l/2,"margin-bottom":-l/2});wi.css({"margin-bottom":l/2});bi.css({"margin-top":l/2});ki.css({width:y,height:l,"margin-left":-y/2-1,"margin-top":-l/2-1});rt&&ut&&(i=(y-u)/2*h.scale,r=(l-f)/2*h.scale,h.scrollBy(i,r),ei(rt,ut))}function er(n){rr(n)}function ru(){st.off("change");st=null;tt?(tt.off("rotatemove"),tt.off("rotateend"),tt.destroy(),tt=null):k.off("dblclick");h.destroy();h=null;g.empty();g=null;ft=null;k=null;et=null;ht.css({"background-color":"","background-repeat":"","background-position":"","background-size":""});ht=null}var b=this,pt=s.size,ot=s.adaptive,wt=s.outputSize,lt=s.outputType||"image/jpeg",or=s.outputQuality,hi=s.file,ci=s.source,sr=s.view,hr=s.ok,li=s.loadStart,cr=s.loadComplete,gt=s.loadError,ai=s.clipFinish,lr=s.lrzOption,it,st,d,a,v,rt,ut,vi,g,ft,k,et,ht,yi,pi,wi,bi,ki,nt,tt,h,ri,ui,fi,dt,yt,p,w,c;n.isArray(pt)||(pt=[260,260]);n.isArray(wt)||(wt=[0,0]);var bt=pt[0]||260,kt=pt[1]||260,ni=Math.max(wt[0],0),ti=Math.max(wt[1],0),at,vt,ii,y,l;if(n.isArray(ot)&&(ot[0]&&(at=ur(ot[0])?ot[0]:!1),ot[1]&&(vt=ur(ot[1])?ot[1]:!1)),lt==="jpg"?lt="image/jpeg":lt==="png"&&(lt="image/png"),it=!1,hi)if(window.FileReader){if(st=n(hi),st.length){f||st.attr("accept","image/jpeg, image/x-png, image/gif");st.on("change",function(){var n,t;if(this.files.length)if(n=this.files[0],/image\/\w+/.test(n.type))it||(it=!0,li.call(b,n)),t=new FileReader,t.onprogress=function(n){console.log((n.loaded/n.total*100).toFixed()+"%")},t.onload=function(){r(n,lr).then(function(n){rr(n.base64);it=!1}).catch(function(n){console.log("图片处理失败");gt.call(b,n);it=!1})},t.onerror=function(n){console.log("图片加载失败");gt.call(b,n);it=!1},t.readAsDataURL(n);else return console.log("图片格式不正确，请选择正确格式的图片文件！"),gt.call(b,"Image format error"),!1});st.click(function(){this.value=""})}}else alert("您的浏览器不支持 HTML5 的 FileReader API，因此不能使用 file 控件上传图片！");ci&&er(ci);iu();vr();pr();wr();fi=n(hr);fi.length&&fi.click(function(){br()});dt=n(window);nr();dt.resize(nr);b.setSize=fr;b.setImg=er;b.rotateCW=oi;b.rotateCCW=di;b.destroy=ru}var f=!!navigator.userAgent.match(/mobile/i),o={size:[260,260],adaptive:null,outputSize:[0,0],outputType:"jpg",outputQuality:.8,file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},u="",e;return function(){var n,i={Webkit:"webkit",Moz:"",O:"o"},r=document.documentElement,f=function(t){return n?n+t:t.toLowerCase()};for(var t in i)if(r.style[t+"TransitionProperty"]!==undefined){u="-"+t.toLowerCase()+"-";n=i[t];break}e=f("TransitionEnd")}(),s});
//# sourceMappingURL=jquery.photoClip.min.js.map
